<% if flash[:notice] %>
  <div class="weight--semibold text--center" ><br>
    <%= flash[:notice] %>  <% flash[:notice] = nil %><br>
  </div>
<% end %>
<% if @search_query.present? && (@search_query.errors.present? || @search_query.errors.any?) %>
  <h2 class="gamma text--center"><%= pluralize(@search_query.errors.count, "error") %> prohibited this search from being processed:</h2>
  <ul class="validation-list" >
    <% @search_query.errors.messages.each do |key, msg| %>
      <li class="validation-list__error text--center" ><%= msg[0] %></li>
    <% end %>
  </ul>
  <% @search_query.errors.clear %>
<% end %>
<div class="bmd_search_form">
  <%= semantic_form_for(@search_query) do |f| %>
    <div class="grid search_form">
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <label class="ttip" for="first_name" tabindex="0">
          First name(s)
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional. Use upper- or lower-case. Abbreviations and Latin versions of the forename (first-name) will be included automatically</span>
        </label>
        <% if @search_query.first_name.nil? %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input">
        <% else %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input" value="<%=@search_query.first_name%>">
        <% end %>
        <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
          <%= f.check_box :fuzzy, {},  true, false %>
          <small class="optional_checkbox_label">Exact match on first names</small>
        <% end %>
      </div>
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <label class="ttip" for="last_name" tabindex="0">
          Surname
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Use upper- or lower-case. If you do not enter a surname (last-name) you <em>must</em> enter a forename, select one county and choose a single record type</span>
        </label>
        <% if @search_query.last_name.nil? %>
          <input id="last_name" name="search_query[last_name]" type="text" class="text-input">
        <% else %>
          <input id="last_name" name="search_query[last_name]" type="text" class="text-input" value="<%=@search_query.last_name%>">
        <% end %>
        <%= f.label :witness, { :class => "optional_attributes", :tabindex => "0" } do %>
          <%= f.check_box :witness, {},  true, false %>
          <small class="optional_checkbox_label">Phonetic search surnames</small>
        <% end %>
      </div>
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <label class="ttip" for="start_year" tabindex="0">
          Date range from
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional, YYYY. The first year you want to search</span>
        </label>
        <% if @search_query.start_year.nil? %>
          <%= select_month(Date.today, {use_short_month: true}, :class => 'select_month_year' ) %>
          <%= select_year(Date.today, {start_year: 1992, end_year: 2007, prompt: '- - - -'}, {:class => 'select_month_year'}) %>
        <% else %>
          <input id="start_year" name="search_query[start_year]" type="text" class="text-input" value="<%=@search_query.start_year%>">
        <% end %>
      </div>
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <label class="ttip" for="start_year" tabindex="0">
          Date range to
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional, YYYY. The first year you want to search</span>
        </label>
        <% if @search_query.start_year.nil? %>
          <%= select_month(Date.today, {use_short_month: true}, :class => 'select_month_year' ) %>
          <%= select_year(Date.today, {start_year: 1992, end_year: 2007, prompt: '- - - -'}, {:class => 'select_month_year'}) %>
        <% else %>
          <input id="start_year" name="search_query[start_year]" type="text" class="text-input" value="<%=@search_query.start_year%>">
        <% end %>
      </div>
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <label class="ttip" for="end_year" tabindex="0">
          Record Type
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional, YYYY. The last year you want to search</span>
        </label>
        <% if @search_query.end_year.nil? %>
          <span class="stack_fields">
            <%= f.label :fuzzy, { :class => "header_label", :tabindex => "0" } do %>
              <%= f.check_box :fuzzy, {},  true, false %>
              <span class="optional_checkbox_label">Select All</span>
            <% end %>
            <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
              <%= f.check_box :fuzzy, {},  true, false %>
              <span class="optional_checkbox_label">Birth</span>
            <% end %>
            <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
              <%= f.check_box :fuzzy, {},  true, false %>
              <span class="optional_checkbox_label">Death</span>
            <% end %>
            <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
              <%= f.check_box :fuzzy, {},  true, false %>
              <span class="optional_checkbox_label">Marriages</span>
            <% end %>
          </span>
        <% else %>
          <input id="end_year" name="search_query[end_year]" type="text" class="text-input" value="<%=@search_query.end_year%>">
        <% end %>
      </div>
      <div class="grid__item one-quarter lap-one-half palm-one-whole">
        <label class="ttip" for="first_name" tabindex="0">
         Spouses first name(s)
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional. Use upper- or lower-case. Abbreviations and Latin versions of the forename (first-name) will be included automatically</span>
        </label>
        <% if @search_query.first_name.nil? %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input">
        <% else %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input" value="<%=@search_query.first_name%>">
        <% end %>
        <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
          <%= f.check_box :fuzzy, {},  true, false %>
          <small class="optional_checkbox_label">Identifiable spouses only</small>
        <% end %>
      </div>
      <div class="grid__item one-quarter lap-one-half palm-one-whole">
        <label class="ttip" for="last_name" tabindex="0">
          Spouses/Mothers surname
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Use upper- or lower-case. If you do not enter a surname (last-name) you <em>must</em> enter a forename, select one county and choose a single record type</span>
        </label>
        <% if @search_query.last_name.nil? %>
          <input id="last_name" name="search_query[last_name]" type="text" class="text-input">
        <% else %>
          <input id="last_name" name="search_query[last_name]" type="text" class="text-input" value="<%=@search_query.last_name%>">
        <% end %>
      </div>
      <div class="grid__item one-quarter lap-one-half palm-one-whole">
        <label class="ttip" for="first_name" tabindex="0">
         Date of birth / Death age
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional. Use upper- or lower-case. Abbreviations and Latin versions of the forename (first-name) will be included automatically</span>
        </label>
        <% if @search_query.first_name.nil? %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input">
        <% else %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input" value="<%=@search_query.first_name%>">
        <% end %>
        <%= f.label :fuzzy, { :class => "optional_attributes", :tabindex => "0" } do %>
          <%= f.check_box :fuzzy, {},  true, false %>
          <small class="optional_checkbox_label">Match only recorded ages</small>
        <% end %>
      </div>
      <div class="grid__item one-eighth lap-one-half palm-one-whole">
        <label class="ttip" for="start_year" tabindex="0">
          Volume
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional, YYYY. The first year you want to search</span>
        </label>
        <% if @search_query.start_year.nil? %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input">
        <% else %>
          <input id="start_year" name="search_query[start_year]" type="text" class="text-input" value="<%=@search_query.start_year%>">
        <% end %>
      </div>
      <div class="grid__item one-eighth lap-one-half palm-one-whole">
        <label class="ttip" for="start_year" tabindex="0">
          Page
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Optional, YYYY. The first year you want to search</span>
        </label>
        <% if @search_query.start_year.nil? %>
          <input id="first_name" name="search_query[first_name]" type="text" class="text-input">
        <% else %>
          <input id="start_year" name="search_query[start_year]" type="text" class="text-input" value="<%=@search_query.start_year%>">
        <% end %>
      </div>
      <div class="grid__item three-eighths lap-three-quarters palm-one-whole" id="search_query_chapman_codes_input">
        <label class="ttip" for="last_name" tabindex="0">
          Counties
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">If you select multiple counties, <em>all</em> places within those counties will be searched. We use the county boundaries as they were in 1831</span>
        </label>
        <% grouped_options = ChapmanCode.add_parenthetical_codes(ChapmanCode.remove_codes(ChapmanCode::CODES)) %>
        <% key = @search_query.chapman_codes unless @search_query.chapman_codes.nil?%>
        <%= f.select :chapman_codes, grouped_options_for_select(grouped_options, selected_key = key), {prompt: 'All Counties'}, {multiple: true} %>
        <small class="additional">Select one place or none</small>
      </div>
      <div class="grid__item three-eighths lap-three-quarters palm-one-whole"  id="search_query_places_input">
        <label class="ttip" for="last_name" tabindex="0">
          Districts
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">If you select multiple counties, <em>all</em> places within those counties will be searched. We use the county boundaries as they were in 1831</span>
        </label>
        <% grouped_options = ChapmanCode.add_parenthetical_codes(ChapmanCode.remove_codes(ChapmanCode::CODES)) %>
        <% key = @search_query.chapman_codes unless @search_query.chapman_codes.nil?%>
        <%= f.select :chapman_codes, grouped_options_for_select(grouped_options, selected_key = key), {prompt: 'All Counties'}, {multiple: true} %>
        <small class="additional">Select one place or none</small>
      </div>
    </div>
    <div class="grid action">
      <%#= f.action :submit,
      :as => :button,
      :label => 'Search ',
      :button_html => { :class => "ladda-button" , "data-style" => "contract" ,"data-color" =>"#a1185a" , "data-size" => "l", "data-spinner-color" => "#ffffff" },
      :wrapper_html => { :class => "grid__item one-whole push-half--ends" } %>
      <%= link_to 'Clear Form', '#', class: 'clear_form' %>
      <%= f.submit 'Search', class: 'search_form_submit_button' %>
    </div>
  <% end %>
</div>
<script type="text/javascript">
  Ladda.bind( 'button[type=submit]' );
</script>
<script type="text/javascript" >
  <% if @search_query && @search_query.chapman_codes.size > 0 %>
    var selection=<%= raw(PlaceCache.where(:chapman_code => @search_query.chapman_codes.first).first.places_json) %>;
    <% if @search_query.places.size > 0 %>
      selection["selected"]="<%= @search_query.places.first.id %>";
    <% end %>
  <% end %>
  (function($) {$("#search_query_place_ids").remoteChained({
    parents : "#search_query_chapman_codes",
    url : "/places/for_search_form.json",
    loading : "Loading..."
    <% if @search_query && @search_query.chapman_codes.size == 1 %>
      , bootstrap: selection
    <% end %>
  });})(jQuery);
  $(function(){
    $("#search_query_place").hide();  // By default use jQuery to hide the second modal
  
    // We can use the change(); function to watch the state of the select box and run some conditional logic every time it's changes to hide or show the second select box
    $("#search_query_chapman_codes").change(function(){
        if( $("#default").is(':selected') ){
            $("#search_query_place").show();
            $("#search_query_place_ids").hide();
        } else {
            $("#search_query_place").hide();
            $("#search_query_place_ids").show();
        }
    });
  })
</script>
