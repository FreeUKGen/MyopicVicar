<% if flash[:notice] %>
  <div class="weight--semibold text--center" ><br>
    <%= flash[:notice] %>  <% flash[:notice] = nil %><br>
  </div>
<% end %>
<% if @search_query.present? && (@search_query.errors.present? || @search_query.errors.any?) %>
  <h2 class="gamma text--center"><%= pluralize(@search_query.errors.count, "error") %> prohibited this search from being processed:</h2>
  <ul class="validation-list" >
    <% @search_query.errors.messages.each do |key, msg| %>
      <li class="validation-list__error text--center" ><%= msg[0] %></li>
    <% end %>
  </ul>
<% end %>
<div class="bmd_search_form">
  <%= semantic_form_for(@search_query) do |f| %>
    <div class="grid search_form">

      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'first_name', 'First name(s)', class: "ttip" %>
          <%= label_tag 'first_name', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '0', title: info_tag_text[:firstname]%>
        </div>
        <%= text_field_tag 'search_query[first_name]', set_value(@search_query.first_name), class: 'text-input', placeholder: 'Enter first name(s) here', tabindex: '1'%>
        <%= check_box_tag 'search_query[first_name_exact_match]', true, false %>
        <%= content_text(:small,'Exact match on first names') %>
      </div>

      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'last_name', 'Surname', class: "ttip" %>
          <%= label_tag 'last_name', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '3'%>
        </div>
        <%= text_field_tag 'search_query[last_name]', set_value(@search_query.last_name), class: 'text-input', id: 'last_name', placeholder: 'Enter Surname here', tabindex: '4' %>
        <%= check_box_tag 'search_query[fuzzy]', true, false %>
        <%= content_text(:small, 'Phonetic search surnames') %>
      </div>


      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'start_quarter', 'Date range from', class: "ttip" %>
          <%= label_tag 'start_year', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '6'%>
        </div>
          <!--span class="ttip__text">Optional, YYYY. The first year you want to search</span-->
          <%= select_tag( 'search_query[start_quarter]', options_for_select([['Mar', 1], ['Jun', 2], ['Sep', 3], ['Dec', 4]], set_value(@search_query.start_quarter)), class: 'select_month_start', id: 'date_year') %>
          <%= select_year(set_value(@search_query.start_year), { start_year: 1837, end_year: 1992, prompt: '- - - -' }, class: 'select_year_start', name: 'search_query[start_year]') %>
      </div>

      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'to_year', 'Date range to', class: "ttip" %>
          <%= label_tag 'to_year', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '6'%>
        </div>
        <%= select_tag( 'search_query[end_quarter]', options_for_select([['Mar', 1], ['Jun', 2], ['Sep', 3], ['Dec', 4]], set_value(@search_query.end_quarter)), class: 'select_month_end', id: 'date_year') %>
        <%= select_year(set_value(@search_query.end_year), {start_year: 1837, end_year: 1992, prompt: '- - - -'}, class: 'select_year_end', name: 'search_query[end_year]') %>
      </div>

      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'record_type', 'Record Type', class: "ttip" %>
          <%= label_tag 'record_type', "#{app_icons[:info]}".html_safe, class: 'ttip_text', tabindex: '0', title: info_tag_text[:record_type]%>
        </div>
        <span class="stack_fields">
          <%= f.label :select_all, { :class => "header_label", :tabindex => "0" } do %>
            <%= check_box_tag 'search_query[bmd_record_type][]', '0',false,{ multiple: true, class: 'checkAll', id: 'bmd_record_type_all' } %>
            <%= content_text(:optional_checkbox_label, 'Select All') %>
          <% end %>
          <%= f.label :birth, { :class => "optional_attributes", :tabindex => "0" } do %>
            <%= check_box_tag 'search_query[bmd_record_type][]', 1,false,{ multiple: true, class: 'checkboxtag', id: 'bmd_record_type_birth' } %>
            <%= content_text(:optional_checkbox_label, 'Birth') %>
          <% end %>
          <%= f.label :death, { :class => "optional_attributes", :tabindex => "0" } do %>
            <%= check_box_tag 'search_query[bmd_record_type][]', 2,false,{ multiple: true, class: 'checkboxtag', id: 'bmd_record_type_death' } %>
            <%= content_text(:optional_checkbox_label, 'Death') %>
          <% end %>
          <%= f.label :marriage, { :class => "optional_attributes", :tabindex => "0" } do %>
            <%= check_box_tag 'search_query[bmd_record_type][]', 3,false,{ multiple: true, class: 'checkboxtag' , id: 'bmd_record_type_marriage'} %>
            <%= content_text(:optional_checkbox_label, 'Marriage') %>
          <% end %>
        </span>
      </div>
      <div class="grid__item one-fifth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'spouse_first_name', 'Spouses first name(s)', class: "ttip" %>
          <%= label_tag 'spouse_first_name', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '0', title: info_tag_text[:firstname]%>
        </div>
        <%= text_field_tag 'search_query[spouse_first_name]', set_value(@search_query.spouse_first_name), class: 'text-input', placeholder: 'Enter spouse first name(s) here', tabindex: '1'%>
        <%= check_box_tag 'hello', true, false %>
        <%= content_text(:small,'Identifiable spouses only') %>
      </div>
            
      <div class="grid__item one-quarter lap-one-half palm-one-whole">
        <label class="ttip" for="last_name" tabindex="0">
          Spouses/Mothers surname
          <i class="fa fa-info-circle"></i>
          <span class="ttip__text">Use upper- or lower-case. If you do not enter a surname (last-name) you <em>must</em> enter a forename, select one county and choose a single record type</span>
        </label>
        <% if @search_query.last_name.nil? %>
          <input id="last_name" name="search_query[mother_last_name]" type="text" class="text-input">
        <% else %>
          <input id="last_name" name="search_query[mother_last_name]" type="text" class="text-input" value="<%=@search_query.mother_last_name%>">
        <% end %>
      </div>

      <div class="grid__item one-quarter lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'date_of_birth_or_age_at_death', 'Date of birth / Death age', class: "ttip" %>
          <%= label_tag 'date_of_birth_or_age_at_death', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '0', title: info_tag_text[:firstname]%>
        </div>
        <%= text_field_tag 'search_query[age_at_death]', set_value(@search_query.age_at_death), pattern: "[0-9-%]{0,10}", class: 'text-input', id: 'age_at_death', placeholder: '', tabindex: '4' %>
        <%= check_box_tag 'search_query[match_recorded_ages_or_dates]', true, false %>
        <%= content_text(:small, 'Match only recorded ages') %>
      </div>

      <div class="grid__item one-eighth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'volume', 'Volume', class: "ttip" %>
          <%= label_tag 'volume', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '3'%>
        </div>
        <%= text_field_tag 'search_query[volume]', set_value(@search_query.volume), class: 'text-input', id: 'volume', placeholder: 'Enter Volume', tabindex: '4' %>
      </div>

      <div class="grid__item one-eighth lap-one-half palm-one-whole">
        <div class='labels'>
          <%= label_tag 'page', 'Page', class: "ttip" %>
          <%= label_tag 'page', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '3'%>
        </div>
        <%= text_field_tag 'search_query[page]', set_value(@search_query.page), class: 'text-input', id: 'page', placeholder: 'Enter Page', tabindex: '4' %>
      </div>

      <div class="grid__item three-eighths lap-three-quarters palm-one-whole" id="search_query_chapman_codes_input">
        <div class='labels'>
          <%= label_tag 'chapman_codes', 'Counties', class: "ttip" %>
          <%= label_tag 'chapman_codes', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '0', title: info_tag_text[:firstname]%>
        </div>
        
        <% grouped_options = ChapmanCode.add_parenthetical_codes(ChapmanCode.remove_codes(ChapmanCode::CODES)) %>
        <% key = @search_query.chapman_codes unless @search_query.chapman_codes.nil?%>
        <%= f.select :chapman_codes, grouped_options_for_select(grouped_options, selected_key = key), {include_blank: 'All Counties'}, {multiple: true} %>
        <small class="additional">Select one place or none</small>
      </div>
      <div class="grid__item three-eighths lap-three-quarters palm-one-whole"  id="search_query_chapman_codes_input">
        <div class='labels'>
          <%= label_tag 'districts', 'Districts', class: "ttip" %>
          <%= label_tag 'districts', "#{app_icons[:info]}".html_safe, class: 'ttip', tabindex: '0', title: info_tag_text[:firstname]%>
        </div>
        <% districts_names = DistrictToCounty.joins(:District).distinct%>
        <%= f.select :districts, districts_names.pluck(:DistrictName), {include_hidden: false}, {multiple: true} %>
        <small class="additional">Select one place or none</small>
      </div>
    </div>
    <div class="grid action">
      <%#= f.action :submit,
      :as => :button,
      :label => 'Search ',
      :button_html => { :class => "ladda-button" , "data-style" => "contract" ,"data-color" =>"#a1185a" , "data-size" => "l", "data-spinner-color" => "#ffffff" },
      :wrapper_html => { :class => "grid__item one-whole push-half--ends" } %>
      <%= button_tag 'Clear Form', type: :reset, class: 'clear_form' %>
      <%= submit_tag 'Search', class: 'search_form_submit_button' , id: 'search_form_submit'%>

    </div>
  <% end %>
</div>
<script type="text/javascript">
  Ladda.bind( 'button[type=submit]' );
</script>

<script type="text/javascript">
  $('.checkAll').on('change', function(e) {
    var $inputs = $('.checkboxtag');
    if(e.originalEvent === undefined) {
        var allChecked = true;
        $inputs.each(function(){
            allChecked = allChecked && this.checked;
        });
        this.checked = allChecked;
    } else {
        $inputs.prop('checked', this.checked);
    }
});

$('.checkboxtag').on('change', function(){
    $('.checkAll').trigger('change');
});
</script>

<script>
$(document).ready(function(){
  $("#search_query_chapman_codes").change(function() {
    var counties = [];
    $.each($("#search_query_chapman_codes option:selected"), function(){
      counties.push($(this).val())
    });
    $.ajax({
      url:  "/search_queries/districts_of_selected_counties",
      type: "GET",
      data: { selected_counties: counties }
    });
  });

  $('#bmd_record_type_marriage, #bmd_record_type_all').change(function() {
    if ($("#bmd_record_type_marriage").is(":checked")) {
      $('#age_at_death').val('')
      $('#age_at_death').prop('placeholder', '');
      $('#age_at_death').prop('disabled', true)
    }  else {
      $('#age_at_death').prop('disabled', false)
    }
  });

  $('#bmd_record_type_birth, #bmd_record_type_death').change(function() {
    if (!$('#age_at_death').prop('disabled')) {
      if ($('#bmd_record_type_death').is(':checked') && !$('#bmd_record_type_birth').is(':checked'))  {
        $('#age_at_death').prop('placeholder', 'Enter Age at Death here');
        $('#age_at_death').prop('name', 'search_query[age_at_death]')
      } else if ($('#bmd_record_type_birth').is(':checked') && !$('#bmd_record_type_death').is(':checked'))  {
        $('#age_at_death').prop('placeholder', 'Enter Date of Birth here');
        $('#age_at_death').prop('name', 'search_query[date_of_birth]')
      } else {
        $('#age_at_death').prop('placeholder', '');
      }
    }
  });


 $('#search_form_submit').click(function() {
  if($('#age_at_death').val()) {
     if ($('#bmd_record_type_death').is(':checked') && $('#bmd_record_type_birth').is(':checked'))  {
        $('#bmd_record_type_death, #bmd_record_type_birth')[0].setCustomValidity('Please choose either birth or death record type if Date of birth / Death age is provided');
    }
    if (!$('#bmd_record_type_death').is(':checked') && !$('#bmd_record_type_birth').is(':checked'))  {
        $('#bmd_record_type_death, #bmd_record_type_birth')[0].setCustomValidity('Please choose either birth or death record type if Date of birth / Death age is provided');
    }
  }

  var age_at_death = $('#age_at_death').val();
   if ((age_at_death.includes('-')) && !(age_at_death.includes('%')))  {
    var x = age_at_death.split('-')
    if ((x[0] >= x[1])) {
      $('#age_at_death')[0].setCustomValidity('Invalid age range.');
    }
  }

  if ((age_at_death.includes('-')) && (age_at_death.includes('%'))) {
      $('#age_at_death')[0].setCustomValidity("Invalid age or age range.");
   }
 });
});
</script>