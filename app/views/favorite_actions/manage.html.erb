<% content_for :title, "Manage Favorite Actions" %>

<div class="container">
  <h2>Manage Favorite Actions</h2>
  <p style="color: #666;">Select up to 5 actions to mark as favorites from the list of available actions below. They will appear at the top of your action sidebar.</p>

  <%= form_with url: update_favorites_path, method: :post, local: true, id: "favorites-form" do |form| %>
    <!-- Error message container -->
    <div id="error-message" style="display: none; color: red; background-color: #ffe6e6; border: 1px solid #ff9999; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
      Please select no more than 5 actions
    </div>
    <div style="margin-top: 20px;" class="push--bottom">
      <%= form.submit "Update Favorites", style: "background-color: #007fad; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;" %>
      <%= link_to "Cancel", :back, style: "background-color: #6c757d; color: white; padding: 5px 16px; text-decoration: none; border-radius: 4px; display: inline-block;" %>
    </div>    
    <div style="display: flex; gap: 20px;">
      <div style="flex: 2;">
        <!--h4>Available Actions</h4-->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px;">
          <% @available_actions.each_slice(3) do |action_group| %>
            <% action_group.each do |action| %>
              <div style="border: 1px solid #ddd; padding: 12px; background-color: #fafafa; border-radius: 4px;">
                <div style="margin-bottom: 8px;">
                  <%= check_box_tag "favorite_actions[]", action, @favorite_actions.include?(action), 
                      class: "form-check-input", id: "action_#{action.parameterize}", 
                      style: "margin-right: 8px;" %>
                  <strong><%= action %></strong>
                </div>
              </div>
            <% end %>
            <!-- Fill empty slots if the last row has fewer than 3 items -->
            <% (3 - action_group.length).times do %>
              <div></div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <%= form.submit "Update Favorites", style: "background-color: #007fad; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;" %>
      <%= link_to "Cancel", :back, style: "background-color: #6c757d; color: white; padding: 5px 16px; text-decoration: none; border-radius: 4px; display: inline-block;" %>
    </div>
  <% end %>
</div>

<script>
  function updateFavoriteCount() {
    const selected = document.querySelectorAll('input[name="favorite_actions[]"]:checked');
    const count = selected.length;
    document.getElementById('favorite-count').textContent = count;
    
    // Hide error message when count is valid
    if (count <= 5) {
      hideErrorMessage();
    }
    
    // Disable remaining checkboxes if 5 are selected
    const checkboxes = document.querySelectorAll('input[name="favorite_actions[]"]');
    checkboxes.forEach(checkbox => {
      if (count >= 5 && !checkbox.checked) {
        checkbox.disabled = true;
      } else {
        checkbox.disabled = false;
      }
    });
  }

  function removeFavorite(action) {
    // Try multiple ID formats to find the checkbox
    const possibleIds = [
      'action_' + action.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase(),
      'action_' + action.replace(/\s+/g, '-').toLowerCase(),
      'action_' + action.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()
    ];
    
    let checkbox = null;
    for (const id of possibleIds) {
      checkbox = document.getElementById(id);
      if (checkbox) break;
    }
    
    if (checkbox) {
      checkbox.checked = false;
      updateFavoriteCount();
    } else {
      console.log('Checkbox not found for action:', action, 'Tried IDs:', possibleIds);
    }
  }

  function showErrorMessage() {
    const errorDiv = document.getElementById('error-message');
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function hideErrorMessage() {
    const errorDiv = document.getElementById('error-message');
    errorDiv.style.display = 'none';
  }

  function validateForm(event) {
    const selected = document.querySelectorAll('input[name="favorite_actions[]"]:checked');
    if (selected.length > 5) {
      event.preventDefault();
      showErrorMessage();
      return false;
    }
    return true;
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('favorites-form');
    const checkboxes = document.querySelectorAll('input[name="favorite_actions[]"]');
    
    // Add form validation
    form.addEventListener('submit', validateForm);
    
    // Add change listeners to checkboxes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateFavoriteCount);
    });
    
    updateFavoriteCount();
  });
</script>
